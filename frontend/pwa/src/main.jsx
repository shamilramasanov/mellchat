import React from 'react';
import ReactDOM from 'react-dom/client';
import { I18nextProvider } from 'react-i18next';
import { Toaster } from 'react-hot-toast';
import App from './app/App';
import i18n from './i18n';
// Removed WebSocketProvider: NewUI –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π WS –ø—Ä–æ–≤–∞–π–¥–µ—Ä
import './styles/globals.css';
import './styles/tailwind.css';
import { TOAST_CONFIG } from './shared/utils/constants';

// Register Service Worker (only in production)
if ('serviceWorker' in navigator && import.meta.env.PROD) {
  // –£–¥–∞–ª—è–µ–º –í–°–ï —Å—Ç–∞—Ä—ã–µ Service Workers —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–∞ (–¥–æ load event)
  (async () => {
    try {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
        console.log('üóëÔ∏è Unregistered Service Worker:', registration.active?.scriptURL || registration.scope);
      }
    } catch (error) {
      console.warn('Failed to unregister old Service Workers:', error);
    }
  })();

  window.addEventListener('load', async () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–∞ –ø–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
    const registerSW = async (swPath) => {
      try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª - —ç—Ç–æ JavaScript, –Ω–µ HTML
        const response = await fetch(swPath, { 
          method: 'GET', 
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
        if (!response.ok) {
          console.warn(`‚ö†Ô∏è Service Worker file ${swPath} returned status ${response.status}`);
          return false;
        }
        
        const contentType = response.headers.get('content-type');
        const text = await response.text();
        
        // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å HTML, —ç—Ç–æ –Ω–µ Service Worker - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
        if (text.trim().startsWith('<!') || text.trim().startsWith('<html') || text.trim().startsWith('<!DOCTYPE')) {
          console.warn(`‚ö†Ô∏è Service Worker file ${swPath} is HTML, not JavaScript`);
          return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º content-type
        if (!contentType?.includes('javascript') && !contentType?.includes('application/javascript') && !contentType?.includes('text/javascript')) {
          console.warn(`‚ö†Ô∏è Service Worker file ${swPath} has wrong content-type: ${contentType}`);
          return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ JavaScript –∫–æ–¥
        if (!text.includes('addEventListener') && !text.includes('self') && !text.includes('serviceWorker') && !text.includes('navigator')) {
          console.warn(`‚ö†Ô∏è Service Worker file ${swPath} doesn't look like a valid SW`);
          return false;
        }
        
        const registration = await navigator.serviceWorker.register(swPath, {
          scope: '/'
        });
        console.log('‚úÖ Service Worker registered:', swPath, registration);
        return true;
      } catch (error) {
        // –¢–∏—Ö–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - –Ω–µ –ª–æ–≥–∏—Ä—É–µ–º –∫–∞–∫ –∫—Ä–∏—Ç–∏—á–Ω—ã–µ
        if (error.message.includes('405') || error.message.includes('404')) {
          console.debug(`Service Worker ${swPath} not available on server`);
        } else {
          console.warn(`‚ö†Ô∏è Failed to register ${swPath}:`, error.message);
        }
        return false;
      }
    };
    
    // Try sw-v3.js first (generated by VitePWA), then service-worker.js
    // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º sw.js - –æ–Ω –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å HTML –Ω–∞ Vercel
    const success = await registerSW('/sw-v3.js');
    if (!success) {
      console.log('sw-v3.js not available, trying service-worker.js...');
      await registerSW('/service-worker.js');
    }
  });
}

// –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ Service Workers –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞)
if ('serviceWorker' in navigator) {
  (async () => {
    try {
      const registrations = await navigator.serviceWorker.getRegistrations();
      for (const registration of registrations) {
        await registration.unregister();
        console.log('üóëÔ∏è Unregistered old Service Worker:', registration.active?.scriptURL || registration.scope);
      }
    } catch (error) {
      // Ignore errors
    }
  })();
}

// iOS viewport height fix
const setVH = () => {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
};

setVH();
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', setVH);

ReactDOM.createRoot(document.getElementById('root')).render(
  <I18nextProvider i18n={i18n}>
      <App />
    <Toaster {...TOAST_CONFIG} />
  </I18nextProvider>
);

// Vercel trigger
// Force Service Worker update Wed Oct 29 22:09:22 EET 2025
