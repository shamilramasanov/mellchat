# Authentication System Logic - Система авторизации

## 🎯 Концепция

**Двойная система авторизации:**
1. **Google OAuth** (уже существует)
2. **Собственная авторизация** через email + код подтверждения (БЕСПЛАТНО!)
3. После регистрации пользователь может добавить пароль в настройках

## 📐 Процесс регистрации

### Шаг 1: Ввод email адреса

```
┌─────────────────────────────────────────────┐
│  Регистрация / Вход                        │
├─────────────────────────────────────────────┤
│                                              │
│  Email адрес                                │
│  [example@email.com]                        │
│  [Отправить код]                            │
│                                              │
│  или                                        │
│                                              │
│  [🔵 Войти через Google]                    │
│                                              │
└─────────────────────────────────────────────┘
```

**Валидация:**
- Формат email адреса
- Проверка существования email в БД (если есть → вход, если нет → регистрация)

### Шаг 2: Отправка кода на email

```
┌─────────────────────────────────────────────┐
│  Подтверждение email                        │
├─────────────────────────────────────────────┤
│                                              │
│  Мы отправили код на example@email.com      │
│                                              │
│  Введите код из письма                     │
│  [ _ ] [ _ ] [ _ ] [ _ ] [ _ ] [ _ ]       │
│                                              │
│  Не пришел код?                             │
│  [Отправить снова] (через 2 мин)            │
│                                              │
│  [Назад]                                    │
└─────────────────────────────────────────────┘
```

**Логика:**
- Отправка кода на email через SMTP (Gmail, SendGrid, Mailgun)
- Код из 6 цифр
- Время жизни кода: 10 минут (дольше чем SMS)
- Лимит повторной отправки: 1 раз в 2 минуты
- Хранение кода в Redis с TTL 10 минут

### Шаг 3: Проверка кода и создание/вход

```
┌─────────────────────────────────────────────┐
│  ✅ Код подтвержден                         │
├─────────────────────────────────────────────┤
│                                              │
│  Добро пожаловать в MellChat!              │
│                                              │
│  [Продолжить]                               │
│                                              │
└─────────────────────────────────────────────┘
```

**После подтверждения:**
- Если пользователь **новый** → создается запись в БД
- Если пользователь **существующий** → вход
- Генерируется JWT токен
- Редирект в приложение

## 📧 Процесс входа

### Для существующих пользователей:

```
┌─────────────────────────────────────────────┐
│  Вход                                       │
├─────────────────────────────────────────────┤
│                                              │
│  [📧 По email]                              │
│  [🔵 Через Google]                          │
│  [🔑 По email и паролю]                    │
│                                              │
└─────────────────────────────────────────────┘
```

**Варианты входа:**
1. **По email** → код подтверждения на email (как при регистрации)
2. **Через Google** → OAuth (существующий)
3. **По email и паролю** → если пользователь установил пароль в настройках

## ⚙️ Настройки профиля (добавление данных)

### После регистрации пользователь может:

```
┌─────────────────────────────────────────────┐
│  📝 Дополнительные данные                   │
├─────────────────────────────────────────────┤
│                                              │
│  Имя пользователя                           │
│  [Иван Иванов]                              │
│  [Сохранить]                                │
│                                              │
│  Email (уже привязан)                        │
│  example@email.com                           │
│  [Изменить]                                 │
│                                              │
│  Пароль                                      │
│  [●●●●●●●●]                                │
│  [Установить пароль]                        │
│                                              │
└─────────────────────────────────────────────┘
```

### Процесс добавления пароля:

```
Шаг 1: Пользователь нажимает "Установить пароль"
Шаг 2: Вводит новый пароль (минимум 8 символов)
Шаг 3: Подтверждает пароль
Шаг 4: Сохраняется хэш пароля в БД
Шаг 5: Теперь можно входить по email + паролю
```

## 🗄️ Структура БД

### Таблица `app_users`

```sql
CREATE TABLE app_users (
  id VARCHAR(255) PRIMARY KEY,
  email VARCHAR(255) UNIQUE,
  email_verified BOOLEAN DEFAULT false,
  password_hash VARCHAR(255),
  name VARCHAR(255),
  avatar_url TEXT,
  google_id VARCHAR(255) UNIQUE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  last_login_at TIMESTAMP
);
```

**Индексы:**
- `idx_app_users_email` - для быстрого поиска по email
- `idx_app_users_google_id` - для поиска по Google ID

### Таблица `email_verifications`

Для подтверждения email адресов (если нужно менять email):

```sql
CREATE TABLE email_verifications (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR(255),
  email VARCHAR(255) NOT NULL,
  token VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP NOT NULL,
  verified BOOLEAN DEFAULT false
);
```

### Таблица `password_reset_tokens`

Для восстановления пароля:

```sql
CREATE TABLE password_reset_tokens (
  id SERIAL PRIMARY KEY,
  user_id VARCHAR(255) NOT NULL,
  token VARCHAR(255) UNIQUE NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP NOT NULL,
  used BOOLEAN DEFAULT false
);
```

## 🔐 Безопасность

### Rate Limiting

**Email отправка:**
- Максимум 5 запросов в час на один email
- Минимальный интервал между отправками: 2 минуты
- Используется Redis для отслеживания лимитов

### Защита от брутфорса

**Проверка кода:**
- Максимум 5 попыток на один код
- После 5 неудачных попыток код удаляется
- Код действителен 10 минут

### JWT токены

- Секретный ключ из переменной окружения `JWT_SECRET`
- Время жизни: 7 дней
- Payload: `userId`, `email`

## 📧 Email сервис

### Провайдеры (все бесплатные для старта):

1. **Gmail SMTP** (рекомендуется) ⭐⭐⭐⭐⭐
   - Бесплатно до 500 писем/день
   - Простая настройка
   - Отличная доставляемость

2. **SendGrid**
   - Бесплатно до 100 писем/день
   - API простой

3. **Mailgun**
   - Бесплатно до 5000 писем/месяц
   - Первые 3 месяца

4. **Mock режим** (для разработки)
   - Логирует код в консоль
   - Не отправляет реальные письма

**Подробнее:** `docs/EMAIL_AUTH_RECOMMENDATION.md`

## 🔄 Связывание аккаунтов

Пользователь может:
1. Зарегистрироваться через email
2. Затем привязать Google аккаунт
3. Или наоборот: Google → добавить email

**Правила:**
- Один email = один аккаунт
- Один Google ID = один аккаунт
- Если email/Google уже привязан к другому аккаунту → ошибка

## 🚨 Восстановление пароля

```
Шаг 1: Пользователь нажимает "Забыли пароль?"
Шаг 2: Вводит email
Шаг 3: Отправляется письмо с токеном сброса
Шаг 4: Переходит по ссылке
Шаг 5: Вводит новый пароль
Шаг 6: Пароль обновляется, токен помечается как использованный
```

## 📊 API Endpoints

### Регистрация/Вход

- `POST /auth/email/send-code` - Отправить код на email
- `POST /auth/email/verify-code` - Проверить код и войти/зарегистрироваться

### Google OAuth

- `GET /auth/google` - Начать OAuth
- `GET /auth/google/callback` - Callback от Google

### Профиль

- `GET /auth/me` - Получить текущего пользователя (требует auth)

### Верификация

- `POST /auth/verify` - Проверить JWT токен

## 🎨 Frontend компоненты

- `EmailInput.jsx` - Ввод email адреса
- `EmailAuthScreen.jsx` - Экран авторизации через email
- `CodeInput.jsx` - Ввод 6-значного кода (общий компонент для email)

## ✅ Преимущества email авторизации

- ✅ **Бесплатно** - не нужны платные SMS сервисы
- ✅ **Удобно** - большинство пользователей проверяют email чаще SMS
- ✅ **Безопасно** - email не так легко перехватить как SMS
- ✅ **Масштабируемо** - можно отправлять тысячи писем бесплатно (Gmail до 500/день)

## 📝 Примечания

- Email адреса нормализуются (lowercase, trim)
- Коды хранятся в Redis, не в БД (для скорости)
- Токены верификации хранятся в БД (для долгосрочного хранения)
- Все письма отправляются асинхронно, ошибки логируются
